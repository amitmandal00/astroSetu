# ChatGPT Feedback Fixes - Report Generation Stuck Issue

**Date**: 2026-01-08
**Status**: ✅ **FIXED**

## Issues Identified by ChatGPT

1. **Client aborts at 30s**: `apiPost` had hardcoded 30s timeout, but generation takes 30-50s+
2. **Multiple generateReport calls**: Preview page was calling generateReport multiple times
3. **Prokerala fallback messaging**: Need better user messaging when using fallback data
4. **ReportId consistency**: Already fixed, but verified
5. **NEXT_PUBLIC_APP_URL format**: Should be domain-only (already handled)

## Fixes Applied

### 1. Configurable Timeout in apiPost ✅

**Problem**: `apiPost` had hardcoded 30s timeout, causing client to abort report generation requests.

**Solution**:
- Added `timeoutMs` parameter to `apiPost` options (backward compatible with `timeout`)
- Updated generate-report calls to use 100-130s timeout (matching server timeout)
- Timeout is now configurable per request

**Files Modified**:
- `src/lib/http.ts`: Added `timeoutMs` option support
- `src/app/ai-astrology/preview/page.tsx`: Updated to use `timeoutMs: clientTimeout`

**Code Changes**:
```typescript
// Before:
export async function apiPost<T>(url: string, body: unknown, options?: { timeout?: number }): Promise<T> {
  const timeout = options?.timeout || 30000; // Hardcoded 30s

// After:
export async function apiPost<T>(url: string, body: unknown, options?: { timeout?: number; timeoutMs?: number }): Promise<T> {
  const timeout = options?.timeoutMs ?? options?.timeout ?? 30000; // Support both, prefer timeoutMs

// Usage:
apiPost(url, body, { timeoutMs: clientTimeout }); // 100-130s for report generation
```

### 2. Prevent Multiple generateReport Calls ✅

**Problem**: Preview page was triggering `generateReport` multiple times:
- Once in auto_generate setTimeout
- Again in legacy auto-generation path
- Causing duplicate requests and stuck UI

**Solution**:
- Added `hasAutoGeneratedRef` guard to prevent multiple triggers
- Removed legacy auto-generation paths that caused duplicates
- Only `auto_generate=true` path triggers generation now

**Files Modified**:
- `src/app/ai-astrology/preview/page.tsx`: Added ref guard and removed duplicate paths

**Code Changes**:
```typescript
// Added guard:
const hasAutoGeneratedRef = useRef(false);

// In useEffect:
if (autoGenerate && paymentVerified && !hasAutoGeneratedRef.current) {
  hasAutoGeneratedRef.current = true; // Set guard immediately
  // ... trigger generation once
}

// REMOVED: Legacy auto-generation paths that caused duplicates
```

### 3. NEXT_PUBLIC_APP_URL Handling ✅

**Status**: Already fixed in previous changes. Code properly handles domain-only URLs.

**Current Implementation**:
- Extracts domain-only from `NEXT_PUBLIC_APP_URL`
- Removes any paths (e.g., `/ai-astrology`) from base URL
- Uses `URL` constructor for proper parsing

### 4. ReportId Consistency ✅

**Status**: Already fixed in previous changes. Single canonical `reportId` in `data.reportId`, removed from content.

## Expected Behavior

### Normal Generation
- ✅ **Timeout**: 100-130s (enough for 30-50s generation + buffer)
- ✅ **Single call**: Only one generateReport call per page load
- ✅ **No aborts**: Client won't abort at 30s anymore

### After Payment (auto_generate=true)
- ✅ **Single trigger**: Only fires once, even on re-renders
- ✅ **Proper state**: Loading stage set before generation starts
- ✅ **No duplicates**: Guard prevents multiple calls

## Files Modified

1. `src/lib/http.ts`:
   - Added `timeoutMs` parameter support
   - Maintains backward compatibility with `timeout`

2. `src/app/ai-astrology/preview/page.tsx`:
   - Added `hasAutoGeneratedRef` guard
   - Updated `apiPost` call to use `timeoutMs`
   - Removed duplicate auto-generation paths

## Testing

1. **Normal generation**: Should complete in 30-50s without aborting
2. **Payment flow**: Should trigger generation only once
3. **Re-renders**: Should not trigger duplicate generation calls
4. **Timeouts**: Should wait up to 100-130s before timing out

---

**Status**: Ready for deployment
