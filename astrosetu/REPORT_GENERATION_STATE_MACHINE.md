# Report Generation State Machine

**Purpose:** This document defines the contract for report generation states and transitions. This contract MUST NOT be broken without updating this document and all dependent tests.

**Last Updated:** 2025-01-XX

---

## State Definitions

### Core States

The report generation flow uses the following state variables:

```typescript
// Primary state indicators
loading: boolean                    // Is report generation in progress?
loadingStage: "verifying" | "generating" | null  // Current stage within loading
error: string | null                // Error message if generation failed
reportContent: ReportContent | null // Generated report content (null = not ready)
paymentVerified: boolean            // Has payment been verified? (paid reports only)

// Bundle-specific states
bundleGenerating: boolean           // Is bundle generation in progress?
bundleProgress: { current: number; total: number; currentReport: string } | null

// Internal refs (not state, but important for flow)
isGeneratingRef.current: boolean    // Lock to prevent concurrent generation
hasAutoGeneratedRef.current: boolean // Guard to prevent duplicate auto-generation
```

---

## State Machine Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                     REPORT GENERATION FLOW                      │
└─────────────────────────────────────────────────────────────────┘

INPUT
  │
  ├─[Free Report (life-summary)]──────────────────────────────────┐
  │                                                               │
  └─[Paid Report]──────────────────────────────────────────┐      │
                                                           │      │
                    PAYMENT_PENDING                        │      │
                      (needsPayment)                       │      │
                           │                               │      │
                           │                               │      │
                    PAYMENT_VERIFYING                      │      │
                 (loadingStage="verifying")                │      │
                           │                               │      │
                           ├─[Payment Failed]──────────────┘      │
                           │        │                             │
                           │   PAYMENT_FAILED                     │
                           │   (error set)                        │
                           │        │                             │
                           │        └─[Retry]───┐                │
                           │                    │                │
                    PAYMENT_VERIFIED            │                │
                   (paymentVerified=true)       │                │
                           │                    │                │
                           └────────────────────┘                │
                                                                  │
                    GENERATING                                    │
              (loadingStage="generating")                         │
                      │                                           │
                      ├─[Success]─────────────────────────────┐  │
                      │                                       │  │
                      └─[Failure]──────────────────────────┐ │  │
                                                            │ │  │
                    COMPLETED                            FAILED │ │
              (reportContent !== null)            (error set) │ │
                      │                                       │ │
                      │                                       │ │
                      └───────────────────────────────────────┴─┘
```

---

## State Transitions

### Valid Transitions

#### 1. INITIAL → INPUT
- **Condition:** User navigates to `/ai-astrology/preview` with input data
- **State Changes:**
  - `input` set from URL params or sessionStorage
  - `reportType` set from URL params or sessionStorage
  - `loading = false`
  - `error = null`

#### 2. INPUT → PAYMENT_PENDING (Paid Reports Only)
- **Condition:** `reportType !== "life-summary" && !paymentVerified`
- **State Changes:**
  - `needsPayment = true`
  - User sees payment prompt
- **Blocked States:** Cannot proceed to GENERATING without payment

#### 3. INPUT → GENERATING (Free Reports)
- **Condition:** `reportType === "life-summary" && input exists`
- **State Changes:**
  - `loading = true`
  - `loadingStage = "generating"`
  - `loadingStartTimeRef.current = Date.now()`
  - `hasAutoGeneratedRef.current = true`
- **Auto-trigger:** Happens automatically when conditions are met

#### 4. PAYMENT_PENDING → PAYMENT_VERIFYING
- **Condition:** User completes payment, redirects with `session_id`
- **State Changes:**
  - `loading = true`
  - `loadingStage = "verifying"`
  - `loadingStartTimeRef.current = Date.now()`
- **API Call:** `/api/ai-astrology/verify-payment?session_id=...`

#### 5. PAYMENT_VERIFYING → PAYMENT_VERIFIED
- **Condition:** Payment verification succeeds
- **State Changes:**
  - `paymentVerified = true`
  - Payment token stored in sessionStorage
- **Next:** Automatically transitions to GENERATING

#### 6. PAYMENT_VERIFYING → PAYMENT_FAILED
- **Condition:** Payment verification fails
- **State Changes:**
  - `loading = false`
  - `loadingStage = null`
  - `error = "Payment verification failed..."`
  - `loadingStartTimeRef.current = null`
- **User Action:** Can retry payment

#### 7. PAYMENT_VERIFIED → GENERATING
- **Condition:** Payment verified, auto-generation triggers
- **State Changes:**
  - `loading = true`
  - `loadingStage = "generating"`
  - `loadingStartTimeRef.current = Date.now()` (if not already set)
  - `hasAutoGeneratedRef.current = true`
- **Auto-trigger:** Happens automatically after payment verification

#### 8. GENERATING → COMPLETED
- **Condition:** API returns `status: "completed"` with report content
- **State Changes:**
  - `loading = false`
  - `loadingStage = null`
  - `reportContent = { reportId, content, ... }`
  - `loadingStartTimeRef.current = null`
  - `isGeneratingRef.current = false`
- **UI:** Report preview displayed

#### 9. GENERATING → FAILED
- **Condition:** API returns error or timeout occurs
- **State Changes:**
  - `loading = false`
  - `loadingStage = null`
  - `error = "Error message..."`
  - `loadingStartTimeRef.current = null`
  - `isGeneratingRef.current = false`
  - `hasAutoGeneratedRef.current = false` (allows retry)
- **User Action:** Can retry generation

#### 10. FAILED → GENERATING (Retry)
- **Condition:** User clicks "Retry" button
- **State Changes:**
  - `loading = true`
  - `loadingStage = "generating"`
  - `error = null`
  - `loadingStartTimeRef.current = Date.now()`
  - `hasAutoGeneratedRef.current = true`
- **API Call:** `/api/ai-astrology/generate-report`

---

## Invalid Transitions (MUST NOT HAPPEN)

These transitions are **forbidden** and indicate a bug:

1. ❌ **GENERATING → PAYMENT_PENDING** - Cannot go backwards to payment
2. ❌ **COMPLETED → GENERATING** (without user action) - Should not auto-regenerate
3. ❌ **GENERATING → GENERATING** (concurrent) - `isGeneratingRef` should prevent this
4. ❌ **PAYMENT_VERIFIED → PAYMENT_PENDING** - Cannot un-verify payment
5. ❌ **COMPLETED → FAILED** - Completed reports don't fail

---

## State Combinations (Valid)

### Free Report States
- `loading = false, reportContent = null, error = null` → INPUT (initial)
- `loading = true, loadingStage = "generating"` → GENERATING
- `loading = false, reportContent !== null` → COMPLETED
- `loading = false, error !== null` → FAILED

### Paid Report States
- `needsPayment = true, paymentVerified = false` → PAYMENT_PENDING
- `loading = true, loadingStage = "verifying"` → PAYMENT_VERIFYING
- `paymentVerified = true, loading = false` → PAYMENT_VERIFIED (brief, auto-transitions)
- `loading = true, loadingStage = "generating", paymentVerified = true` → GENERATING
- `loading = false, reportContent !== null, paymentVerified = true` → COMPLETED
- `loading = false, error !== null` → FAILED

### Bundle Report States
- Same as paid reports, but with:
  - `bundleGenerating = true` during generation
  - `bundleProgress = { current: X, total: Y, currentReport: "..." }`

---

## Guards and Constraints

### Concurrent Generation Prevention
- **Guard:** `isGeneratingRef.current`
- **Rule:** If `isGeneratingRef.current === true`, `generateReport()` must return early
- **Set:** At start of `generateReport()` function
- **Clear:** In finally block or error handler

### Auto-Generation Prevention
- **Guard:** `hasAutoGeneratedRef.current`
- **Rule:** Prevents duplicate auto-generation triggers
- **Set:** Before calling `generateReport()` in auto-generation flow
- **Clear:** On error or manual retry

### Timer Management
- **Rule:** `loadingStartTimeRef.current` should only be set when starting generation
- **Rule:** Timer useEffect should only run when `loading === true`
- **Rule:** Timer should not reset during generation (ref prevents this)

---

## Error Handling States

### Fatal Errors (No Retry)
- **Condition:** 403, 429, 500 errors, SERVICE_DISABLED
- **Action:** Show error, stop retry attempts
- **State:** `loading = false, error !== null, hasAutoGeneratedRef = false`

### Retryable Errors
- **Condition:** Network errors, timeouts, rate limits (non-429)
- **Action:** Show error, allow retry
- **State:** `loading = false, error !== null, hasAutoGeneratedRef = false`

### Timeout Handling
- **Threshold:** 
  - Verification: 30 seconds
  - Complex reports (full-life, major-life-phase): 130 seconds
  - Regular reports: 100 seconds
- **Action:** Set error, clear loading state, allow retry

---

## API Contracts

### Required API Responses

#### Generate Report API
```typescript
// Success Response
{
  ok: true,
  data: {
    status: "completed" | "processing" | "pending",
    reportId: string,
    reportContent?: ReportContent,
    // ... other fields
  }
}

// Error Response
{
  ok: false,
  error: string
}
```

#### Verify Payment API
```typescript
// Success Response
{
  ok: true,
  data: {
    paid: boolean,
    paymentToken?: string,
    paymentIntentId?: string,
    reportType?: ReportType
  }
}
```

---

## Testing Contracts

When writing tests, verify:

1. ✅ State transitions follow the defined flow
2. ✅ Invalid transitions are prevented
3. ✅ Guards (`isGeneratingRef`, `hasAutoGeneratedRef`) work correctly
4. ✅ Timer starts/stops at correct states
5. ✅ Error states allow appropriate retry actions
6. ✅ Payment flow completes before generation starts (paid reports)

---

## Breaking Changes

**⚠️ WARNING:** If you modify state transitions or state definitions:

1. **Update this document** first
2. **Update all E2E tests** that depend on states
3. **Run full test suite** before committing
4. **Document migration path** if state changes affect existing flows

---

## Related Files

- `src/app/ai-astrology/preview/page.tsx` - Main implementation
- `src/app/api/ai-astrology/generate-report/route.ts` - API endpoint
- `src/app/api/ai-astrology/verify-payment/route.ts` - Payment verification
- `tests/e2e/*.spec.ts` - E2E tests (to be created)

---

## Notes for Cursor/AI Assistants

**When modifying report generation logic:**

1. ✅ **DO:** Follow the state machine transitions defined above
2. ✅ **DO:** Maintain guards (`isGeneratingRef`, `hasAutoGeneratedRef`)
3. ✅ **DO:** Update state in the correct order (loading → stage → content/error)
4. ❌ **DON'T:** Create new state transitions without updating this document
5. ❌ **DON'T:** Remove guards without understanding their purpose
6. ❌ **DON'T:** Change state variable names without updating this document
7. ❌ **DON'T:** Modify API response schemas without updating contracts section

**Before committing changes:**
- Run `npm run test:e2e` to verify state transitions
- Check that guards are still in place
- Verify timer logic hasn't broken

